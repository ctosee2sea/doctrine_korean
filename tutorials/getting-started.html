<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Getting Started with Doctrine &mdash; Doctrine 2 ORM 2 documentation</title>
    <link rel="stylesheet" href="../src/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../src/default.css" type="text/css" />
    <link rel="stylesheet" href="../src/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../src/layout.css" type="text/css" />
    <link rel="stylesheet" href="../src/configurationblock.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>

    <script type="text/javascript" src="../src/jquery.js"></script>
    <script type="text/javascript" src="../src/configurationblock.js"></script>
    <script type="text/javascript" src="../src/underscore.js"></script>
    <script type="text/javascript" src="../src/configurationblock.js"></script>
    <script type="text/javascript" src="../src/doctools.js"></script>
    <script type="text/javascript" src="../src/configurationblock.js"></script>
    <script src="../src/bootstrap.min.js"></script>

    <script type="text/javascript">
    <!--
        $(document).ready(function() {
            $("#versions").change(function() {
                var docsUrl = $(this).val();
                window.location.href = docsUrl;
            });
        });
    -->
    </script>
    <link rel="shortcut icon" href="../src/doctrine.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="Doctrine 2 ORM 2 documentation" href="../index.html" />
    <link rel="next" title="Getting Started: Database First" href="getting-started-database.html" />
    <link rel="prev" title="Welcome to Doctrine 2 ORM’s documentation!" href="../index.html" /> 
  
<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/tutorials/getting-started.html" />

<link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="../src/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = 'tutorials/getting-started' 		
READTHEDOCS_DATA['source_suffix'] = '.rst'
</script>

<script type="text/javascript" src="../src/readthedocs-dynamic-include.js"></script>

<!-- end RTD <extrahead> --></head>
  <body>
    <div id="wrapper">
      <div id="header">
        <h1 id="h1title"></h1>
        <div id="logo">
          <a href="http://www.doctrine-project.org/">Doctrine - PHP Database Libraries</a>
        </div>
      </div>
      <div id="nav" class="cls">
        <div class="tl cls">
          <ul>
            <li><a target="_top" href="http://www.doctrine-project.org/">Home</a></li>
            <li><a target="_top" href="http://www.doctrine-project.org/about.html">About</a></li>
            <li><a target="_top" href="http://www.doctrine-project.org/projects.html">Projects</a></li>
            <li><a target="_top" href="http://www.doctrine-project.org/contribute.html">Contribute</a></li>
            <li><a target="_top" href="http://www.doctrine-project.org/community.html">Community</a></li>
            <li><a target="_top" href="http://www.doctrine-project.org/archive.html">Blog</a></li>
            <li><a target="_top" href="http://www.doctrine-project.org/jira">Development</a></li>
          </ul>
        </div>
      </div>
      <div id="content" class="cls">
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="getting-started-database.html" title="Getting Started: Database First"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../index.html" title="Welcome to Doctrine 2 ORM’s documentation!"
             accesskey="P">previous</a> |</li>
        <li><a href="/">Doctrine Homepage</a> &raquo;</li>
        <li><a href="../index.html">Doctrine 2 ORM 2 documentation</a> &raquo;</li> 
      </ul>
    </div>  

        <div class="document">
            <div class="documentwrapper">
                <div class="bodywrapper">

              <div class="body" >
                
  <div class="section" id="getting-started-with-doctrine">
<h1>독트린 시작하기<a class="headerlink" href="#getting-started-with-doctrine" title="Permalink to this headline">¶</a></h1>
<p>이 안내서는 독트린 ORM을 시작하는 방법을 다룹니다. 학습 목표는 아래와 같습니다.</p>
<ul class="simple">
<li>독트린을 데이터베이스에 연결하여 설치하고 구성할 줄 안다.</li>
<li>PHP 객체를 데이터베이스 테이블에 매핑 시킨다.</li>
<li>PHP 객체에서 데이터베이스 스키마를 생성한다.</li>
<li><code class="docutils literal"><span class="pre">EntityManager</span></code>를 사용하여 데이터베이스에서 객체를 삽입, 수정, 삭제 및 찾기를 할 수 있다.</li>
</ul>
<div class="section" id="guide-assumptions">
<h2>안내서의 요구 사항<a class="headerlink" href="#guide-assumptions" title="Permalink to this headline">¶</a></h2>
<p>이 안내서는 이전에 독트린 ORM을 사용해보지 않은 초보자를 대상으로 합니다. <br />
이 튜토리얼을 위해 설치해야 할 것들이 몇 가지 있습니다.</p>
<ul class="simple">
<li>PHP (안정적인 최신 버젼)</li>
<li>컴포져 패키지 매니져 (<a class="reference external" href="http://getcomposer.org/doc/00-intro.md">컴포져 설치</a>)</li>
</ul>
<p>이 튜토리얼의 코드는 <a class="reference external" href="https://github.com/doctrine/doctrine2-orm-tutorial">깃허브에 있습니다.</a>.</p>
<div class="admonition note">
<p class="first admonition-title">노트</p>
<p class="last">이 튜토리얼은 <strong>독트린 2.4</strong> 이상에서 작업해야 합니다. <br />
일부 코드는 하위버젼에서 작동하지 않을 수 있습니다.</p>
</div>
</div>
<div class="section" id="what-is-doctrine">
<h2>독트린은 무엇인가?<a class="headerlink" href="#what-is-doctrine" title="Permalink to this headline">¶</a></h2>
<p>독트린 2는 PHP 객체에 투명한 영속성을 부여하는 PHP 5.4+ 용 <a class="reference external" href="http://en.wikipedia.org/wiki/Object-relational_mapping">객체 관계형 매퍼 (ORM)</a>입니다. <br />
관계형 데이터베이스 시스템 안에서 도메인/비즈니스 로직과 영속성을 완전히 분리시키기 위해 데이터 매퍼 패턴을 중점적으로 사용합니다.</p>
<p>프로그래머가 객체 지향 비즈니스 로직에 집중하고, 영속성은 부차적인 문제로 만드는 것이 독트린의 장점입니다. <br />
독트린 내에서 영속성이 중요하지 않다는 의미가 아니라, 영속성과 엔티티가 분리되어 있을 때 OOP의 이점을 살릴 수 있다는 믿음입니다.</p>
<div class="section" id="what-are-entities">
<h3>엔티티는 무엇인가?<a class="headerlink" href="#what-are-entities" title="Permalink to this headline">¶</a></h3>
<p>엔티티는 고유 Id나 기본키로 요청하여 식별할 수 있는 PHP 객체 입니다. <br />
이 클래스는 추상 기본 클래스나 인터페이스로 확장할 필요가 없습니다. <br />
엔티티 클래스는 최종 클래스이거나 최종 메소드를 포함할 수 없습니다. <br />
게다가 엔티티는 <a class="reference internal" href="../cookbook/implementing-wakeup-or-clone.html"><span class="doc">아주 안전하게</span></a> 하지 않는 한 <strong>복제</strong>나 <strong>깨우기</strong>를 구현할 수 없습니다. <br />
</p>
<p>엔티티는 영속적인 속성을 포함합니다. <br />
영속적인 속성은 독트린의 데이터 매핑 기능을 통해 데이터베이스에 저장되고, 데이터베이스에서 검색할 수 있는 엔티티의 인스턴스 변수입니다.</p>
</div>
</div>
<div class="section" id="an-example-model-bug-tracker">
<h2>예제 모델 : 버그 추적기<a class="headerlink" href="#an-example-model-bug-tracker" title="Permalink to this headline">¶</a></h2>
<p>독트린 시작하기 가이드를 통해 우리는 <a class="reference external" href="http://framework.zend.com/manual/1.12/en/zend.db.adapter.html">Zend_Db_Table</a> 문서에서 버그 추적기 도메인 모델을 구현할 것입니다. <br />
이 문서를 읽으면서 우리는 이러한 요구사항을 도출할 수 있습니다.</p>
<ul class="simple">
<li>각 버그는 설명, 생성 날짜, 상태, 보고자, 엔지니어가 있습니다.</li>
<li>버그는 다른 제품(이나 플랫폼)에서 발생할 수 있습니다.</li>
<li>각 제품은 이름이 있습니다.</li>
<li>버그 보고자와 엔지니어는 모두 시스템 유저입니다.</li>
<li>각 사용자는 새로운 버그를 만들 수 있습니다.</li>
<li>할당받은 엔지니어가 버그를 종료시킬 수 있습니다.</li>
<li>각 유저는 자신이 보고하였거나 할당받은 버그를 볼 수 있습니다.</li>
<li>버그는 list-view를 통해 페이징 할 수 있습니다.</li>
</ul>
</div>
<div class="section" id="project-setup">
<h2>프로젝트 설정<a class="headerlink" href="#project-setup" title="Permalink to this headline">¶</a></h2>
<p>이 튜토리얼 프로젝트를 위해 <code class="docutils literal"><span class="pre">doctrine2-tutorial</span></code> 같은 이름의 새로운 빈 폴더를 만들고, 아래의 내용을 담은 <code class="docutils literal"><span class="pre">composer.json</span></code> 파일을 생성하세요.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;require&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;doctrine/orm&quot;</span><span class="p">:</span> <span class="s2">&quot;2.4.*&quot;</span><span class="p">,</span>
        <span class="s2">&quot;symfony/yaml&quot;</span><span class="p">:</span> <span class="s2">&quot;2.*&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;autoload&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;psr-0&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="s2">&quot;src/&quot;</span><span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>컴포저 의존성 관리 도구로 다음을 호출하여 독트린을 설치합니다.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ composer install
</pre></div>
</div>
<p>독트린 공통 패키지, DBAL, ORM, 심포니 YAML, 심포니 콘솔이 <cite>vendor</cite> 폴더에 설치될 것입니다. <br />
심포니 의존성은 필수가 아니지만, 이 튜토리얼에서는 사용합니다.</p>
<p>다음 폴더들을 추가하십시오.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>doctrine2-tutorial
|-- config
|   |-- xml
|   `-- yaml
`-- src
</pre></div>
</div>
</div>
<div class="section" id="obtaining-the-entitymanager">
<h2>EntityManager 취득하기<a class="headerlink" href="#obtaining-the-entitymanager" title="Permalink to this headline">¶</a></h2>
<p>독트린의 공용 인터페이스는 EntityManager 입니다. <br />
EntityManager는 엔티티와 엔티티 영속성 변경등의 전체 라이프사이클 관리를 위한 액세스 포인트를 제공합니다. <br />
독트린 2에서 엔티티를 사용하기 위해서는 엔티티를 구성하고 생성해야 합니다. <br />
이제 구성 단계를 보여주고, 단계별로 살펴 보겠습니다.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// bootstrap.php</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\Tools\Setup</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityManager</span><span class="p">;</span>

<span class="k">require_once</span> <span class="s2">&quot;vendor/autoload.php&quot;</span><span class="p">;</span>

<span class="c1">// 주석 달기를 위한 간단한 '기본적인' 독트린 ORM 구성 생성</span>
<span class="c1">// Create a simple &quot;default&quot; Doctrine ORM configuration for Annotations</span>
<span class="nv">$isDevMode</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="nx">Setup</span><span class="o">::</span><span class="na">createAnnotationMetadataConfiguration</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="no">__DIR__</span><span class="o">.</span><span class="s2">&quot;/src&quot;</span><span class="p">),</span> <span class="nv">$isDevMode</span><span class="p">);</span>
<span class="c1">// 아니면 yaml이나 XML을 사용하기 위해 아래의 코드 사용</span>
<span class="c1">// or if you prefer yaml or XML</span>
<span class="c1">//$config = Setup::createXMLMetadataConfiguration(array(__DIR__.&quot;/config/xml&quot;), $isDevMode);</span>
<span class="c1">//$config = Setup::createYAMLMetadataConfiguration(array(__DIR__.&quot;/config/yaml&quot;), $isDevMode);</span>

<span class="c1">// 데이터베이스 구성 매개변수</span>
<span class="c1">// database configuration parameters</span>
<span class="nv">$conn</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;driver&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;pdo_sqlite&#39;</span><span class="p">,</span>
    <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="no">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/db.sqlite&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="c1">// 엔티티 관리자 취득</span>
<span class="c1">// obtaining the entity manager</span>
<span class="nv">$entityManager</span> <span class="o">=</span> <span class="nx">EntityManager</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="nv">$conn</span><span class="p">,</span> <span class="nv">$config</span><span class="p">);</span>
</pre></div>
</div>
<p>첫 번째 require 구분은 컴포저 오토로드를 사용해서 독트린 오토로딩 기능을 설정합니다.</p>
<p>두 번째 블록은 설치 도우미를 사용한 ORM <code class="docutils literal"><span class="pre">Configuration</span></code> 객체의 예시로 구성되어 있습니다. <br />
이것은 지금 당장은 신경쓰지 않아도 되는 기본값들을 처리합니다. <br />
<a class="reference internal" href="../reference/configuration.html"><span class="doc">구성에 대한 레퍼전스 장</span></a>에서 구성 상세를 읽을 수 있습니다.
</p>
<p>세 번째 블럭은 데이터베이스 연결을 위한 구성 옵션 요구사항들입니다. 이 경우에는 파일 기반의 sqlite 데이터베이스입니다. <br />
연결 가능한 다른 드라이버들에 대한 구성 옵션들은 <a class="reference external" href="http://docs.doctrine-project.org/projects/doctrine-dbal/en/latest/">DBAL 구성 섹션 메뉴얼</a>에 있습니다. </p>
<p>마지막 블록은 factory 메소드에서 <code class="docutils literal"><span class="pre">EntityManager</span></code>을 취득하는 법을 보여줍니다.</p>
</div>
<div class="section" id="generating-the-database-schema">
<h2>데이터베이스 스키마 생성<a class="headerlink" href="#generating-the-database-schema" title="Permalink to this headline">¶</a></h2>
<p>이제 우리는 메타 데이터 매핑을 정의하고, 우리가 생성하기 원하는 관계형 데이터베이스 스키마를 불러올 EntityManager를 로딩(bootstrap)할 것입니다. <br />
독트린에는 메타데이터 작업에 필요한 테이블을 생성하는 컴포넌트인 SchemaTool에 접근할 수 있는 CLI(Command-Line Interface)가 있습니다.</p>
<p>CLI가 작동하려면 cli-config.php 파일이 독트린 명령어를 실행할 프로젝트의 루트 디렉토리에 위치해야 합니다. 이건 상당히 간단한 파일입니다.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// cli-config.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="k">return</span> <span class="nx">\Doctrine\ORM\Tools\Console\ConsoleRunner</span><span class="o">::</span><span class="na">createHelperSet</span><span class="p">(</span><span class="nv">$entityManager</span><span class="p">);</span>
</pre></div>
</div>
<p>그러면 프로젝트 폴더 안으로 이동해서 독트린 명령줄 도구를 사용할 수 있습니다.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cd project/
$ vendor/bin/doctrine orm:schema-tool:create
</pre></div>
</div>
<p>이 시점에서 <cite>src</cite>에 엔티티 메타데이터가 없으므로 &#8220;No Metadata Classes to process.&#8221; 라는 메시지가 표시됩니다. 다음 섹션에서 Product 엔티티와 해당 메타데이터를 생성할 것이기 때문에 걱정하지 않으셔도 됩니다.</p>
<p>개발 프로세스 중에 주기적으로 엔티티 메타데이터와 동기화되도록 데이터베이스 스키마를 업데이트 해야 한다는 점을 잊지 마세요.</p>
<p>다음과 같이 데이터베이스를 손쉽게 재생성할 수 있습니다.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ vendor/bin/doctrine orm:schema-tool:drop --force
$ vendor/bin/doctrine orm:schema-tool:create
</pre></div>
</div>
<p>혹은 업데이트 기능을 사용할 수 있습니다.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ vendor/bin/doctrine orm:schema-tool:update --force
</pre></div>
</div>
<p>데이터베이스 업데이트시, 독트린 ORM 패키지 없이도 사용할 수 있는 <code class="docutils literal"><span class="pre">Doctrine\DBAL</span></code> 패키지의 기본 데이터베이스 스키마에 대해 Diff 알고리즘이 사용됩니다.</p>
</div>
<div class="section" id="starting-with-the-product">
<h2>Product 시작하기<a class="headerlink" href="#starting-with-the-product" title="Permalink to this headline">¶</a></h2>
<p>우리는 가장 간단한 엔티티 Product부터 시작합니다. <br />
<code class="docutils literal"><span class="pre">src/Product.php</span></code> 파일을 작성해서 다음의 <code class="docutils literal"><span class="pre">Product</span></code> 엔티티 정의를 포함시키십시오.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// src/Product.php</span>
<span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var int</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @var string</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getId</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getName</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setName</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>$id를 제외한 모든 필드는 변경자(getter,setter mutator)가 정의한 protected (public이 아니라)로 설정된다는 점을 유의하세요. <br />
변경자를 사용하면 독트린이 엔티티를 조작하는 호출에 연결할 수 있습니다. [주 : 훅을 걸 수 있습니다.] <br />
이런 기능은 <code class="docutils literal"><span class="pre">entity#field</span> <span class="pre">=</span> <span class="pre">foo;</span></code> 과 같은 방식으로 값을 직접 설정했을 때는 불가능합니다.</p>
<p>id 필드에는 setter 가 없습니다. 일반적으로 이것은 데이터베이스의 id 값을 가리키기 때문에 설정하는 코드를 짜서는 안됩니다. <br />
(독트린 자체는 여전히 정의된 setter 함수 대신 Reflection API를 사용하여 값을 설정할 수 있습니다.)</p>
<p>독트린의 영속성을 위한 다음 단계는 메타데이터 언어를 사용하여 <code class="docutils literal"><span class="pre">Product</span></code> 엔티티의 구조를 독트린에 설명하는 것입니다. <br />
메타데이터 언어는 엔티티가 속성과 참조가 어떻게 영속적이 되는지, 무엇이 적용에 제한되는지 설명합니다. </p>
<p>엔티티 메타데이터는 XML, YAML 혹은 파일 내 주석블럭을 사용하여 구성됩니다. <br />
이 시작 안내서는 모든 매핑 드라이버의 매핑 방법을 보여줍니다. <br />
텍스트 내부 참조는 XML 매핑으로 만들어집니다. </p>
<div class="configuration-block">
<ul class="simple">
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// src/Product.php</span>
<span class="sd">/**</span>
<span class="sd"> * @Entity @Table(name=&quot;products&quot;)</span>
<span class="sd"> **/</span>
<span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
    <span class="sd">/** @Id @Column(type=&quot;integer&quot;) @GeneratedValue **/</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="sd">/** @Column(type=&quot;string&quot;) **/</span>
    <span class="k">protected</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="c1">// .. (other code)</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- config/xml/Product.dcm.xml --&gt;</span>
<span class="nt">&lt;doctrine-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping&quot;</span>
      <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping</span>
<span class="s">                    http://raw.github.com/doctrine/doctrine2/master/doctrine-mapping.xsd&quot;</span><span class="nt">&gt;</span>

      <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">&quot;Product&quot;</span> <span class="na">table=</span><span class="s">&quot;products&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span> <span class="na">type=</span><span class="s">&quot;integer&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;generator</span> <span class="na">strategy=</span><span class="s">&quot;AUTO&quot;</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;/id&gt;</span>

          <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;/doctrine-mapping&gt;</span>
</pre></div>
</div>
</li>
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># config/yaml/Product.dcm.yml</span>
<span class="l l-Scalar l-Scalar-Plain">Product</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">entity</span>
  <span class="l l-Scalar l-Scalar-Plain">table</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">products</span>
  <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">integer</span>
      <span class="l l-Scalar l-Scalar-Plain">generator</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">strategy</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">AUTO</span>
  <span class="l l-Scalar l-Scalar-Plain">fields</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">string</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>최상위 레벨 <code class="docutils literal"><span class="pre">entity</span></code> 정의 태그는 클래스와 테이블 이름 정보를 지정합니다. <br />
초기 타입 <code class="docutils literal"><span class="pre">Product#name</span></code>은 <code class="docutils literal"><span class="pre">field</span></code> 속성으로 정의됩니다. <br />
<code class="docutils literal"><span class="pre">id</span></code> 속성은 <code class="docutils literal"><span class="pre">id</span></code> 태그로 정의되는데, 이 태그는 <code class="docutils literal"><span class="pre">generator</span></code>도 갖습니다. 이 <code class="docutils literal"><span class="pre">generator</span></code> 태그는 자동으로 데이터베이스 플랫폼의 네이티브 id 생성 기능을 기본키 생성 메카니즘으로 사용하도록 정의합니다. (예 : Mysql의 AUTO INCREMENT, PostgreSql과 Oracle의 Sequences)
</p>
<p>첫 번째 엔티티를 정의했으니, 데이터베이스를 업데이트 해봅시다.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ vendor/bin/doctrine orm:schema-tool:update --force --dump-sql
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">--force</span></code>와 <code class="docutils literal"><span class="pre">--dump-sql</span></code> 플래그를 모두 지정하고 DDL 구문을 실행합니다.</p>
<p>이제 데이터베이스에 제품들을 입력하는 스크립트를 작성하겠습니다.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// create_product.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$newProductName</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="nv">$product</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">();</span>
<span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="nv">$newProductName</span><span class="p">);</span>

<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$product</span><span class="p">);</span>
<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

<span class="k">echo</span> <span class="s2">&quot;Created Product with ID &quot;</span> <span class="o">.</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>CLI에서 이 스크립트를 호출해서 신제품이 생성되는 것을 확인하십시오.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ php create_product.php ORM
$ php create_product.php DBAL
</pre></div>
</div>
<p>어떤 일이 벌어졌죠? <code class="docutils literal"><span class="pre">Product</span></code>를 사용한 것은 상당히 OOP 적입니다. <br />
흥미로운 점은 <code class="docutils literal"><span class="pre">EntityManager</span></code> 서비스를 사용한다는 점입니다. <br />
EntityManager에게 새로운 엔티티를 데이터베이스에 입력한다는 것을 알리기 위해, <code class="docutils literal"><span class="pre">persist()</span></code>를 호출해야 합니다. <br />
실제로 트랜잭션을 실행해서 입력하려면, EntityManager상에서 <code class="docutils literal"><span class="pre">flush()</span></code>을 명시하여 호출해야 합니다.
</p>
<p>하나의 트랜잭션 안에 모든 작성문(insert,update,delete)를 집계하고, flush가 호출될 때 이를 실행한다는 것이 persist와 flush의 차이점입니다. <br />
이 접근 방식을 사용하는 것이, 각 엔티티를 개별적으로 업데이트 하는 것보다 성능면에서 낫습니다.</p>
<p>독트린은 요청 중에 호출되고 변경된 모든 엔티티를 감지하는 작업 단위 패턴을 따릅니다. <br />
독트린이 이미 감지하고 있기 때문에, 일부러 엔티티를 추적할 필요는 없습니다.</p>
<p>다음으로 모든 제품 목록을 불러오겠습니다. <br />
다음 스크립트를 작성하겠습니다.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// list_products.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$productRepository</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">);</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nv">$productRepository</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$products</span> <span class="k">as</span> <span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;-%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">EntityManager#getRepository()</span></code> 메소드는 모든 엔티티에 대한 파인더 객체(저장소라 불림)를 생성합니다. <br />
이것은 독트린에서 제공하는 기능이며, <code class="docutils literal"><span class="pre">findAll()</span></code> 과 같은 파인더 메소드가 포함되어 있습니다.</p>
<p>ID를 기반으로 제품 이름을 표시해보겠습니다.</p> 
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// show_product.php &lt;id&gt;</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$id</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="nv">$product</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">,</span> <span class="nv">$id</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$product</span> <span class="o">===</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">&quot;No product found.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;-%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">());</span>
</pre></div>
</div>
<p>제품 이름을 업데이트해보면 앞에서 설명한 작업 단위 패턴 기능을 알 수 있습니다. <br />
우리가 그저 제품 엔티티만 찾으면, 그 속성에 대한 모든 변경 사항이 데이터베이스에 기록됩니다.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// update_product.php &lt;id&gt; &lt;new-name&gt;</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$id</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="nv">$newName</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="nv">$product</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">,</span> <span class="nv">$id</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$product</span> <span class="o">===</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">&quot;Product </span><span class="si">$id</span><span class="s2"> does not exist.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="nv">$newName</span><span class="p">);</span>

<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>
</pre></div>
</div>
<p>이 스크립트로 이미 존재하는 제품 하나를 호출한 후 , <code class="docutils literal"><span class="pre">show_product.php</span></code>를 사용하여 제품 이름이 변경되었음을 확인할 수 있습니다.</p>
</div>
<div class="section" id="adding-bug-and-user-entities">
<h2>버그 및 사용자 엔티티 추가하기<a class="headerlink" href="#adding-bug-and-user-entities" title="Permalink to this headline">¶</a></h2>

<p>버그 추적기 개발을 계속하기 위해,
<code class="docutils literal"><span class="pre">Bug</span></code>와 <code class="docutils literal"><span class="pre">User</span></code>가 없는 클래스를 생성하여, 그것들을 각각 <code class="docutils literal"><span class="pre">src/Bug.php</span></code> 와
<code class="docutils literal"><span class="pre">src/User.php</span></code>에 입력합니다.</p>

<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// src/Bug.php</span>
<span class="sd">/**</span>
<span class="sd"> * @Entity(repositoryClass=&quot;BugRepository&quot;) @Table(name=&quot;bugs&quot;)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">Bug</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Id @Column(type=&quot;integer&quot;) @GeneratedValue</span>
<span class="sd">     * @var int</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;string&quot;)</span>
<span class="sd">     * @var string</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$description</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;datetime&quot;)</span>
<span class="sd">     * @var DateTime</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$created</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;string&quot;)</span>
<span class="sd">     * @var string</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$status</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getId</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getDescription</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">description</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setDescription</span><span class="p">(</span><span class="nv">$description</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="nv">$description</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setCreated</span><span class="p">(</span><span class="nx">DateTime</span> <span class="nv">$created</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">created</span> <span class="o">=</span> <span class="nv">$created</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getCreated</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">created</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setStatus</span><span class="p">(</span><span class="nv">$status</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">status</span> <span class="o">=</span> <span class="nv">$status</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getStatus</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">status</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// src/User.php</span>
<span class="sd">/**</span>
<span class="sd"> * @Entity @Table(name=&quot;users&quot;)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Id @GeneratedValue @Column(type=&quot;integer&quot;)</span>
<span class="sd">     * @var int</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;string&quot;)</span>
<span class="sd">     * @var string</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getId</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getName</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setName</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>지금까지 살펴본 모든 속성은 엔티티의 id 필드, 이름, 설명, 상태, 변경 날짜 등의 간단한 문자열 및 숫자 값이었습니다. <br />
다음으로 엔티티 간의 참조를 정의하여 엔티티 간의 동적 관계를 모델화합니다.</p>
<p>객체 간의 참조는 데이터베이스의 외래 키입니다. <br />
외래 키를 직접 조작 할 필요도 없고 그렇게 해서도 안됩니다. <br />
고유 identity를 통한 외래키를 대표하는 객체를 사용하면 됩니다.
 </p>
 <p>모든 외래 키에 대해 Doctrine ManyToOne 또는 OneToOne 연결을 사용할 수 있습니다. <br />이 외래 키의 반대편에서는 OneToMany 연결을 사용할 수 있습니다. <br />
 두 개의 테이블이 각각의 외래키로 상대 테이블을 join 할 때는 ManyToMany 연결을 사용할 수 있습니다.</p>
 <p>이제 독트린의 참조 기본 사항을 알게 되었습니다. 이제 요구 사항에 맞게 도메인 모델을 확장 해보겠습니다.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// src/Bug.php</span>
<span class="k">use</span> <span class="nx">Doctrine\Common\Collections\ArrayCollection</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Bug</span>
<span class="p">{</span>
    <span class="c1">// ... (이전 코드)</span>

    <span class="k">protected</span> <span class="nv">$products</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">products</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayCollection</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// src/User.php</span>
<span class="k">use</span> <span class="nx">Doctrine\Common\Collections\ArrayCollection</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="c1">// ... (이전 코드)</span>

    <span class="k">protected</span> <span class="nv">$reportedBugs</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$assignedBugs</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">reportedBugs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayCollection</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assignedBugs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayCollection</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>독트린 모델에서 PHP 일반 배열 대신 독트린의 ArrayCollection을 사용하면, 독트린은 내부가 어떻게 작동하는지 지켜보면서, 알맞게 실행됩니다. <br />
엔티티를 덤프하면 ArrayCollection 대신 "PersistentCollection"이 나온다는 점을 유의하세요. <br />
ArrayCollection은 동일한 인터페이스를 사용하는 독트린 내부 클래스입니다.</p>
<div class="admonition warning">
<p class="first admonition-title">경고</p>
<p class="last">지연 로드 프록시는 항상 독트린의 EntityManager 인스턴스와 모든 종속성을 포함합니다. <br />
따라서 var_dump() 명령어는 렌더링하거나 읽을 수 없을 정도로 아주 큰 재귀적 구조를 덤프하게됩니다. <br />
사람이 읽을 수 있을 정도로 제한된 덤핑을 하려면 <code class="docutils literal"><span class="pre">Doctrine\Common\Util\Debug::dump()</span></code> 를 사용해야 합니다. <br />
또한 EntityManager를 브라우저로 덤핑하려면 몇 분정도 걸릴 수 있으며, Debug::dump() 메소드는 프록시 인스턴스에서 EntityManager의 존재를 무시한다는 점에 유의해야 합니다.
</p>
</div>
<p>우리는 참조용 콜렉션에 대해서만 작업하기 때문에, 도메인 모델에서 양방향 참조를 구현할 때 조심해야 합니다.<br>
참조 관계에서 참조하는 측과 참조되는 측이라는 개념은 ORM의 핵심 아이디어이기 때문에, 항상 염두해야 합니다.<br>
독트린 2의 원할한 작동을 위해서는 다음의 가정들이 전재되어야 합니다.<br>
다음의 가정들이 독트린 2 고유의 것은 아니지만, 데이터 베이스 및 ORM를 다루는 모범 사례입니다.</p>

<ul class="simple">
<li>
콜렉션에 대한 변경 사항은 컬렉션의 <em>참조하는</em> 쪽 엔티티가 저장되거나 갱신될 때, 저장되거나 갱신됩니다.</li>
<li>참조 관계에서 참조 되는 쪽에서 엔티티를 저장하는 것으로는, 컬렉션 변경의 영속 운영이 어떤 방식으로든 작동시키지 못합니다.</li>
<li>One-to-One (1:1) 관계에서는 <em>항상</em> 참조하는 쪽에서 자체 데이터베이스 테이블 관계 엔티티의 외래키를 갖고 있습니다.</li>
<li>many-to-many (n:n) 관계에서는 양쪽 모두 참조하는 측이 될 수 있습니다. 그러나 양방향 many-to-many 관계에서는 한개만 허가됩니다.</li>
<li>many-to-one (n:1) 관계에서는 n개 쪽이 외래키를 참조하기 때문에, 기본적으로 n개 측이 참조하는 측이 됩니다.</li>
<li>OneToMany (1:n) 관계에서는 n개 쪽에 외래키가 저장되기 때문에, 기본적으로 반대입니다. <br />
단, Join Table을 사용하며, 1개 측에는 데이터베이스 내에서의 UNIQUE(고유)값만 허락 되는 경우에는, OneToMany(1:n) 관계에서 1개 측만 참조 하는 측이 됩니다.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">노트</p>
<p class="last">
참조 되는 측의 양방향 참조 일관성은 사용자 어플리케이션 코드에서 관리해야 합니다. <br />
독트린이 마술처럼 일관성있게 컬렉션을 업데이트 해주지는 않습니다.</p>
</div>
<p>
사용자와 버그는 앞뒤로 참조 됩니다. 버그를 신고한 유저와 할당받은 유저, 이렇게 양방향 관계입니다. <br />
코드를 변경해서 양방향 참조의 일관성을 보장해야 합니다. </p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// src/Bug.php</span>
<span class="k">class</span> <span class="nc">Bug</span>
<span class="p">{</span>
    <span class="c1">// ... (이전 코드)</span>

    <span class="k">protected</span> <span class="nv">$engineer</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$reporter</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setEngineer</span><span class="p">(</span><span class="nv">$engineer</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$engineer</span><span class="o">-&gt;</span><span class="na">assignedToBug</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">engineer</span> <span class="o">=</span> <span class="nv">$engineer</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setReporter</span><span class="p">(</span><span class="nv">$reporter</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$reporter</span><span class="o">-&gt;</span><span class="na">addReportedBug</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">reporter</span> <span class="o">=</span> <span class="nv">$reporter</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getEngineer</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">engineer</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getReporter</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">reporter</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// src/User.php</span>
<span class="k">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="c1">// ... (이전 코드)</span>

    <span class="k">protected</span> <span class="nv">$reportedBugs</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$assignedBugs</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">addReportedBug</span><span class="p">(</span><span class="nv">$bug</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">reportedBugs</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$bug</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">assignedToBug</span><span class="p">(</span><span class="nv">$bug</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assignedBugs</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$bug</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>참조 되는 쪽의 이름에는 과거형 변수명을 사용했습니다. 그렇게 해서, 실제로 버그가 할당 되었음을 알려주고, 메소드가 참조의 일관성을 보장하기 위해서만 사용됨을 나타냅니다. <br />
이 접근 방식은 제 개인적인 취향이기 때문에, 여러분은 메소드명은 알아서 하시면 됩니다. </p>
<p><code class="docutils literal"><span class="pre">User#addReportedBug()</span></code> 와
<code class="docutils literal"><span class="pre">User#assignedToBug()</span></code>
에서 볼 수 있듯이, 사용자 코드에서는 이 메소드를 실행시켜도 <code class="docutils literal"><span class="pre">Bug#reporter</span></code> 나 <code class="docutils literal"><span class="pre">Bug#engineer</span></code>같은 참조하는 쪽의 컬렉션에 버그를 추가시키지 않습니다. <br />  
즉, 이 메소드를 실행하고, 독트린 호출을 통해 영속성을 부여해도, 데이터베이스의 컬렉션을 업데이트 시키지는 않습니다.

<p><code class="docutils literal"><span class="pre">Bug#setEngineer()</span></code> 나 <code class="docutils literal"><span class="pre">Bug#setReporter()</span></code>를 통해서만 관계 정보가 정확히 저장됩니다.</p>
<p><code class="docutils literal"><span class="pre">Bug#reporter</span></code> 와 <code class="docutils literal"><span class="pre">Bug#engineer</span></code> 속성은 User 를 참조하는 Many-To-One (n:1)  관계입니다. <br />
정규화된 관계 모델에서 외래키는 Bug 테이블에 저장됩니다. <br />
때문에 독트린 ORM에서 Bug 가 참조하는 쪽이 됩니다. <br />
여러분의 도메인 모델의 사용 사례가 독트린 매핑에서 참조하는 측인지 참조 되는 측인지 항상 확인해야 합니다. <br />
이 예에서는 새로운 버그가 등록되거나 엔지니어에게 버그가 할당될 때 참조를 유지하기 위해 User 가 아닌 Bug 를 업데이트 합니다. <br />
이 예는 Bug가 참조하는 쪽에 있는 경우 입니다.
</p>
<p>데이터베이스에서 Bug테이블이 Product 테이블을 참조하듯이, Bug는 Product를 단방향 ManyToMany (n:n)으로 참조합니다.
</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// src/Bug.php</span>
<span class="k">class</span> <span class="nc">Bug</span>
<span class="p">{</span>
    <span class="c1">// ... (이전 코드)</span>

    <span class="k">protected</span> <span class="nv">$products</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">assignToProduct</span><span class="p">(</span><span class="nv">$product</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">products</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$product</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getProducts</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">products</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>이제 요구 사항을 충족하는 도메인 모델을 완성했습니다. <br />
앞에서 <code class="docutils literal"><span class="pre">Product</span></code>에 한 것처럼 
<code class="docutils literal"><span class="pre">User</span></code> 와 <code class="docutils literal"><span class="pre">Bug</span></code> 에 대한 메타데이터 매핑을 추가합니다.</p>
<div class="configuration-block">
<ul class="simple">
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// src/Bug.php</span>
<span class="sd">/**</span>
<span class="sd"> * @Entity @Table(name=&quot;bugs&quot;)</span>
<span class="sd"> **/</span>
<span class="k">class</span> <span class="nc">Bug</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Id @Column(type=&quot;integer&quot;) @GeneratedValue</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;string&quot;)</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$description</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;datetime&quot;)</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$created</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;string&quot;)</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$status</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ManyToOne(targetEntity=&quot;User&quot;, inversedBy=&quot;assignedBugs&quot;)</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$engineer</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ManyToOne(targetEntity=&quot;User&quot;, inversedBy=&quot;reportedBugs&quot;)</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$reporter</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ManyToMany(targetEntity=&quot;Product&quot;)</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$products</span><span class="p">;</span>

    <span class="c1">// ... (other code)</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- config/xml/Bug.dcm.xml --&gt;</span>
<span class="nt">&lt;doctrine-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping&quot;</span>
      <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping</span>
<span class="s">                    http://raw.github.com/doctrine/doctrine2/master/doctrine-mapping.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">&quot;Bug&quot;</span> <span class="na">table=</span><span class="s">&quot;bugs&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span> <span class="na">type=</span><span class="s">&quot;integer&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;generator</span> <span class="na">strategy=</span><span class="s">&quot;AUTO&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>

        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;description&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;created&quot;</span> <span class="na">type=</span><span class="s">&quot;datetime&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;status&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;many-to-one</span> <span class="na">target-entity=</span><span class="s">&quot;User&quot;</span> <span class="na">field=</span><span class="s">&quot;reporter&quot;</span> <span class="na">inversed-by=</span><span class="s">&quot;reportedBugs&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;many-to-one</span> <span class="na">target-entity=</span><span class="s">&quot;User&quot;</span> <span class="na">field=</span><span class="s">&quot;engineer&quot;</span> <span class="na">inversed-by=</span><span class="s">&quot;assignedBugs&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;many-to-many</span> <span class="na">target-entity=</span><span class="s">&quot;Product&quot;</span> <span class="na">field=</span><span class="s">&quot;products&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;/doctrine-mapping&gt;</span>
</pre></div>
</div>
</li>
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># config/yaml/Bug.dcm.yml</span>
<span class="l l-Scalar l-Scalar-Plain">Bug</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">entity</span>
  <span class="l l-Scalar l-Scalar-Plain">table</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bugs</span>
  <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">integer</span>
      <span class="l l-Scalar l-Scalar-Plain">generator</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">strategy</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">AUTO</span>
  <span class="l l-Scalar l-Scalar-Plain">fields</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">text</span>
    <span class="l l-Scalar l-Scalar-Plain">created</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">datetime</span>
    <span class="l l-Scalar l-Scalar-Plain">status</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">string</span>
  <span class="l l-Scalar l-Scalar-Plain">manyToOne</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">reporter</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">targetEntity</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">User</span>
      <span class="l l-Scalar l-Scalar-Plain">inversedBy</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">reportedBugs</span>
    <span class="l l-Scalar l-Scalar-Plain">engineer</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">targetEntity</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">User</span>
      <span class="l l-Scalar l-Scalar-Plain">inversedBy</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">assignedBugs</span>
  <span class="l l-Scalar l-Scalar-Plain">manyToMany</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">products</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">targetEntity</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Product</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>여기서는 엔티티, id 및 초기 타입 정의가 사용 됩니다. <br />
"created" 필드에 <code class="docutils literal"><span class="pre">datetime</span></code> 타입이 사용되었습니다. <code class="docutils literal"><span class="pre">datetime</span></code>은 YYYY-mm-dd HH:mm:ss 데이타베이스 형식을 PHP DataTime 인스턴스로 상호 변환 가능합니다.</p>
<p>필드를 정의한 다음으로 사용자 엔티티를 참조하는 두 개의 참조 필드가 정의됩니다. <br />
이 두 필드는 <code class="docutils literal"><span class="pre">many-to-one</span></code> 태그로 만들어 집니다. <br />
관련 엔티티의 클래스 이름은 <code class="docutils literal"><span class="pre">target-entity</span></code> 속성으로 선언합니다. <code class="docutils literal"><span class="pre">target-entity</span></code> 만 입력하면 데이터 매퍼가 알아서 외부 테이블에 접근합니다. <br />
<code class="docutils literal"><span class="pre">reporter</span></code> 와 <code class="docutils literal"><span class="pre">engineer</span></code>는 양방향 연결에서 참조하는 쪽이기 때문에 <code class="docutils literal"><span class="pre">inversed-by</span></code> 속성을 지정해 줍니다. <br />
<code class="docutils literal"><span class="pre">inversed-by</span></code> 속성들이 참조 관계에서의 참조 되는쪽 필드이름을 가리킵니다. <br />
다음 예제에서 <code class="docutils literal"><span class="pre">inversed-by</span></code> 속성이 참조 되는 쪽의 <code class="docutils literal"><span class="pre">mapped-by</span></code> 필드에 대응 하는 것을 볼 수 있습니다.

</p>
<p>마지막 으로 <code class="docutils literal"><span class="pre">Bug#products</span></code> 컬렉션을 정의합니다. 특정 버그가 발생한 모든 제품 정보가 <code class="docutils literal"><span class="pre">Bug#products</span></code> 컬렉션에 저장됩니다. <br />
<code class="docutils literal"><span class="pre">many-to-many</span></code> 태그에 <code class="docutils literal"><span class="pre">target-entity</span></code> 과 <code class="docutils literal"><span class="pre">field</span></code>  속성도 정의합니다.

</p>
<p>마지막 남은 정의는 User 엔티티 정의입니다.</p>
<div class="configuration-block">
<ul class="simple">
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// src/User.php</span>
<span class="sd">/**</span>
<span class="sd"> * @Entity @Table(name=&quot;users&quot;)</span>
<span class="sd"> **/</span>
<span class="k">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Id @GeneratedValue @Column(type=&quot;integer&quot;)</span>
<span class="sd">     * @var int</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;string&quot;)</span>
<span class="sd">     * @var string</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @OneToMany(targetEntity=&quot;Bug&quot;, mappedBy=&quot;reporter&quot;)</span>
<span class="sd">     * @var Bug[]</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$reportedBugs</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @OneToMany(targetEntity=&quot;Bug&quot;, mappedBy=&quot;engineer&quot;)</span>
<span class="sd">     * @var Bug[]</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$assignedBugs</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>

    <span class="c1">// .. (other code)</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- config/xml/User.dcm.xml --&gt;</span>
<span class="nt">&lt;doctrine-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping&quot;</span>
      <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping</span>
<span class="s">                    http://raw.github.com/doctrine/doctrine2/master/doctrine-mapping.xsd&quot;</span><span class="nt">&gt;</span>

     <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">&quot;User&quot;</span> <span class="na">table=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span> <span class="na">type=</span><span class="s">&quot;integer&quot;</span><span class="nt">&gt;</span>
             <span class="nt">&lt;generator</span> <span class="na">strategy=</span><span class="s">&quot;AUTO&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;/id&gt;</span>

         <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="nt">/&gt;</span>

         <span class="nt">&lt;one-to-many</span> <span class="na">target-entity=</span><span class="s">&quot;Bug&quot;</span> <span class="na">field=</span><span class="s">&quot;reportedBugs&quot;</span> <span class="na">mapped-by=</span><span class="s">&quot;reporter&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;one-to-many</span> <span class="na">target-entity=</span><span class="s">&quot;Bug&quot;</span> <span class="na">field=</span><span class="s">&quot;assignedBugs&quot;</span> <span class="na">mapped-by=</span><span class="s">&quot;engineer&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;/doctrine-mapping&gt;</span>
</pre></div>
</div>
</li>
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># config/yaml/User.dcm.yml</span>
<span class="l l-Scalar l-Scalar-Plain">User</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">entity</span>
  <span class="l l-Scalar l-Scalar-Plain">table</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">users</span>
  <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">integer</span>
      <span class="l l-Scalar l-Scalar-Plain">generator</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">strategy</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">AUTO</span>
  <span class="l l-Scalar l-Scalar-Plain">fields</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">string</span>
  <span class="l l-Scalar l-Scalar-Plain">oneToMany</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">reportedBugs</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">targetEntity</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Bug</span>
      <span class="l l-Scalar l-Scalar-Plain">mappedBy</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">reporter</span>
    <span class="l l-Scalar l-Scalar-Plain">assignedBugs</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">targetEntity</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Bug</span>
      <span class="l l-Scalar l-Scalar-Plain">mappedBy</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">engineer</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p><code class="docutils literal"><span class="pre">one-to-many</span></code> 태그의 새로운 점들이 있습니다. <br />
참조하는 쪽과 참조되는 쪽에 대해 검토한 것을 기억 하시나요? <br />
reportedBugs와 assignedBugs은 모두 참조되는 쪽입니다. <br /> 
즉, 상세 join 내역은 이미 참조 하는 쪽에 정의 되어 있습니다. <br />
때문에 참조하는 쪽인 Bug 클래스에만 속성을 지정하면 됩니다.</p>
<p>이 예제는 메타 데이터 정의 언어의 가장 기본적인 기능에 대한 개요입니다.</p>
<p>데이타베이스 업데이트 실행:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ vendor/bin/doctrine orm:schema-tool:update --force
</pre></div>
</div>
</div>
<div class="section" id="implementing-more-requirements">
<h2>더 많은 요구 사항 구현<a class="headerlink" href="#implementing-more-requirements" title="Permalink to this headline">¶</a></h2>
<p>우선 사용자 엔티티를 만듭니다.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// create_user.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$newUsername</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="nv">$newUsername</span><span class="p">);</span>

<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

<span class="k">echo</span> <span class="s2">&quot;Created User with ID &quot;</span> <span class="o">.</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>이제 호출해 봅니다.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ php create_user.php beberlei
</pre></div>
</div>
<p>다음의 코드는 버그 생성 데이타를 생성하는 코드 입니다.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// create_bug.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$theReporterId</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="nv">$theDefaultEngineerId</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="nv">$productIds</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

<span class="nv">$reporter</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="nv">$theReporterId</span><span class="p">);</span>
<span class="nv">$engineer</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="nv">$theDefaultEngineerId</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$reporter</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$engineer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">&quot;No reporter and/or engineer found for the input.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$bug</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Bug</span><span class="p">();</span>
<span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">setDescription</span><span class="p">(</span><span class="s2">&quot;Something does not work!&quot;</span><span class="p">);</span>
<span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">setCreated</span><span class="p">(</span><span class="k">new</span> <span class="nx">DateTime</span><span class="p">(</span><span class="s2">&quot;now&quot;</span><span class="p">));</span>
<span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">setStatus</span><span class="p">(</span><span class="s2">&quot;OPEN&quot;</span><span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$productIds</span> <span class="k">as</span> <span class="nv">$productId</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$product</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s2">&quot;Product&quot;</span><span class="p">,</span> <span class="nv">$productId</span><span class="p">);</span>
    <span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">assignToProduct</span><span class="p">(</span><span class="nv">$product</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">setReporter</span><span class="p">(</span><span class="nv">$reporter</span><span class="p">);</span>
<span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">setEngineer</span><span class="p">(</span><span class="nv">$engineer</span><span class="p">);</span>

<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$bug</span><span class="p">);</span>
<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

<span class="k">echo</span> <span class="s2">&quot;Your new Bug Id: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>아직 user와 product의 ID가 모두 1 밖에 없기 때문에 스크립트를 아래와 같이 호출합니다.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">php</span> <span class="n">create_bug</span><span class="o">.</span><span class="n">php</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span>
</pre></div>
</div>
<p>처음으로 EntityManager 읽기 API를 사용 하였습니다. <code class="docutils literal"><span class="pre">EntityManager#find($name,</span> <span class="pre">$id)</span></code>를 호출해서 기본키로 불러온 엔티티의 단일 인스턴스가 리턴 되었습니다. <br />
또한 persist + flush 패턴으로 Bug를 데이타베이스에 저장하였습니다.</p>
<p>"첫 번째 프로토 타입"에서 검토한 메소드들을 사용하는 것이 Bug, Reporter, Engineer, Product 연결을 얼마나 간단하게 만드는지 보세요. <br />
UnitOfWork는 flush가 호출될 때 이 참조 관계를 감지하여 데이터베이스 내에서 적절히 참조 관계를 만듭니다.</p>
</div>
<div class="section" id="queries-for-application-use-cases">
<h2>애플리케이션 사용 사례를 위한 쿼리<a class="headerlink" href="#queries-for-application-use-cases" title="Permalink to this headline">¶</a></h2>
<div class="section" id="list-of-bugs">
<h3>버그 목록<a class="headerlink" href="#list-of-bugs" title="Permalink to this headline">¶</a></h3>
<p>앞의 예제만 사용해도 데이터베이스를 채우는데는 문제가 없지만, 기본 매퍼 질의(query)하는 법을 알면 필수적인 뷰를 표현할 수 있습니다. <br />
애플리케이션을 열 때 첫번째 읽기 전용 사용 사례인 리스트뷰를 통해 버그들에 페이지 번호를 매길 수 있습니다.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// list_bugs.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT b, e, r FROM Bug b JOIN b.engineer e JOIN b.reporter r ORDER BY b.created DESC&quot;</span><span class="p">;</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">);</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">setMaxResults</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
<span class="nv">$bugs</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$bugs</span> <span class="k">as</span> <span class="nv">$bug</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getDescription</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot; - &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getCreated</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">format</span><span class="p">(</span><span class="s1">&#39;d.m.Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;    Reported by: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getReporter</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;    Assigned to: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getEngineer</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getProducts</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;    Platform: &quot;</span><span class="o">.</span><span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">echo</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>이 예제의 DQL 쿼리는 30개의 최근 버그들을 각각의 엔지니어와 보고자(reporter)를 단일 SQL문으로 불러옵니다. <br />
다음은 스크립트의 콘솔 출력입니다.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>Something does not work! - 02.04.2010
    Reported by: beberlei
    Assigned to: beberlei
    Platform: My Product
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>DQL 은 SQL 이 아닙니다.</strong></p>
<p>이 예제를 시작하면서, 왜 굳이 SQL을 작성해야 하는지 궁금할 수 있습니다. <br />
끝도 없는 SQL 수작업을 없애기 위해서 ORM을 사용했는데 말이죠. <br />
독트린이 소개하는 DQL을 가장 잘 설명하는 방법은, 이것이 <strong>object-query-language</strong> 이라는 것입니다. DQL은 <a class="reference external" href="http://en.wikipedia.org/wiki/Object_Query_Language">OQL</a>의 파생어이며, <a class="reference external" href="http://www.hibernate.org">HQL</a>이나 <a class="reference external" href="http://en.wikipedia.org/wiki/Java_Persistence_Query_Language">JPQL</a>과 유사합니다.</a>. <br />
DQL은 컬럼과 테이블이라는 개념대신, 엔티티 클래스와 속성이라는 개념을 사용합니다. <br />
앞서 정의해 놓은 메타데이터를 사용하면, 짧고 독특하고 강력한 쿼리를 만들어 낼 수 있습니다.</p>
<p>DQL이 대부분의 ORM API에 비해 나은 중요한 이유는 바로 DQL이 SQL과 비슷하다는 것입니다. <br />
DQL 언어를 사용하면, 대부분의 ORM 에서는 사용할 수 없는 Group by (심지어 HAVING도 쓸 수 있고), 서브 셀렉트, 중첩 클래스의 Fetch-조인, COUNT() 결과 같은 스칼라 데이터와 엔티티의 혼합 등을 사용할 수 있습니다. <br />
DQL을 사용하면 더 강력한 SQL 개념을 지원하지 않는다는 이유로 ORM을 집어 치우고 싶은 생각은 좀처럼 들지 않을 것입니다.</p>
<p>
DQL을 손으로 타이핑 하는 대신 <code class="docutils literal"><span class="pre">$entityManager-&gt;createQueryBuilder()</span></code>를 호출하여 <code class="docutils literal"><span class="pre">QueryBuilder</span></code> 를 사용할 수 있습니다. <br />
이에 대한 더 상세한 점은 문서의 관련 부분에서 보실 수 있습니다. </p>
<p class="last">최후의 수단으로 네이티브 SQL 과 결과 셋의 설명을 사용하여 데이터베이스에서 엔티티를 검색할 수 있습니다. <br />
DQL을 직접 네이티브 SQL과 <code class="docutils literal"><span class="pre">ResultSetMapping</span></code> 인스턴스로 변형시킬 수 있습니다. <br />
네이티브 SQL을 사용하면 저장 프로시저를 사용하여 데이터를 검색하거나, PostgreSql의 재귀 쿼리 같은 고급 고유 데이터베이스 기능을 사용할 수 있습니다.</p>
</div>
</div>
<div class="section" id="array-hydration-of-the-bug-list">
<h3>버그 리스트를 배열로 녹여내기<a class="headerlink" href="#array-hydration-of-the-bug-list" title="Permalink to this headline">¶</a></h3>
<p>우리는 이전의 사용 예제에서 검색하여 각각의 객체 인스턴스로 뽑아내었습니다. <br />
그렇지만 독트린에서 객체로밖에 검색 할 수 없는 건 아닙니다. <br />
앞에서 사용한 것처럼 간단한 목록 보기의 경우에는 엔티티에 대한 읽기 접근만 필요하기 때문에, 객체를 간단한 PHP 배열로 변환하여 사용할 수도 있습니다. </p>
<p>변환에는 조금 더 많은 프로세스가 필요하기 때문에, 필요한 부분만 검색해야 읽기 전용 요청에서 나은 성능을 기대할 수 있습니다.</p>
<p>배열 녹여내기를 사용하여 우리 코드를 수정해서, 위에서 만든 목록 보기를 구현합니다.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// list_bugs_array.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT b, e, r, p FROM Bug b JOIN b.engineer e &quot;</span><span class="o">.</span>
       <span class="s2">&quot;JOIN b.reporter r JOIN b.products p ORDER BY b.created DESC&quot;</span><span class="p">;</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">);</span>
<span class="nv">$bugs</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">getArrayResult</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$bugs</span> <span class="k">as</span> <span class="nv">$bug</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$bug</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot; - &quot;</span> <span class="o">.</span> <span class="nv">$bug</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">format</span><span class="p">(</span><span class="s1">&#39;d.m.Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;    Reported by: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="p">[</span><span class="s1">&#39;reporter&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;    Assigned to: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="p">[</span><span class="s1">&#39;engineer&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$bug</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;    Platform: &quot;</span><span class="o">.</span><span class="nv">$product</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">echo</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>products에 bug를 연결하기 위해 패치-join을 추가해야 한다는 점이 DQL 쿼리의 중요한 차이점입니다. <br />
이 단일 select문에 대한 SQL 쿼리는 길지만, 객체 변환해 바하면 더 효율적입니다.</p>
</div>
<div class="section" id="find-by-primary-key">
<h3>기본 키로 찾기<a class="headerlink" href="#find-by-primary-key" title="Permalink to this headline">¶</a></h3>
<p>다음 사용 사례는 기본 키로 버그를 보여주는 겁니다. <br />
물론 위에서처럼  DQL을 사용해서 where 구문으로 검색할 수도 있겠지만, <code class="docutils literal"><span class="pre">EntityManager</span></code>에는 우리가 이미 쓰기 기능 만들 때 본 적이 있는 더 편리한 메소드가 있습니다.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// show_bug.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$theBugId</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="nv">$bug</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s2">&quot;Bug&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$theBugId</span><span class="p">);</span>

<span class="k">echo</span> <span class="s2">&quot;Bug: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getDescription</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;Engineer: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getEngineer</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>엔지지어 이름이 데이터베이스에서 연결되어 있네요. 어떻게 된 걸까요?</p>
<p>엔지니어와 보고자 정보는 기본키로 버그를 검색할 때 즉시 불러오는 것이 아니라, 지연로딩 프록시에 의해 대체됩니다. <br />
이 프록시는 첫 메소드가 호출 될 때, 내부적으로 실행됩니다. </p>
<p>이 프록시 샘플 코드가 만들어내는 아래와 같은 코드는 지정된 프록시 디렉토리에서 찾을 수 있습니다. </p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\Proxies</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * THIS CLASS WAS GENERATED BY THE DOCTRINE ORM. DO NOT EDIT THIS FILE.</span>
<span class="sd"> **/</span>
<span class="k">class</span> <span class="nc">UserProxy</span> <span class="k">extends</span> <span class="nx">\User</span> <span class="k">implements</span> <span class="nx">\Doctrine\ORM\Proxy\Proxy</span>
<span class="p">{</span>
    <span class="c1">// .. lazy load code here</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">addReportedBug</span><span class="p">(</span><span class="nv">$bug</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_load</span><span class="p">();</span>
        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">addReportedBug</span><span class="p">(</span><span class="nv">$bug</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">assignedToBug</span><span class="p">(</span><span class="nv">$bug</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_load</span><span class="p">();</span>
        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">assignedToBug</span><span class="p">(</span><span class="nv">$bug</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>각 메소드상에서 어떻게 프록시가 데이터베이스 지연 불러오기를 하는지 보셨나요?</p>
<p>출력을 요청해보죠</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ php show_bug.php 1
Bug: Something does not work!
Engineer: beberlei
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">추가 데이터 지연 로딩은 대단히 편리하지만, 별도의 쿼리를 만들어 내는 것은 부하를 생산합니다. <br />
어떤 지정된 필드가 항상 혹은 자주 사용되는지 안다면, 첫 번째 쿼리에 명시하는 것으로 더 나은 성능을 낼 수 있습니다.</p>
</div>
</div>
</div>
<div class="section" id="dashboard-of-the-user">
<h2>사용자 대쉬보드<a class="headerlink" href="#dashboard-of-the-user" title="Permalink to this headline">¶</a></h2>
<p>다음 사용 예제는, 유저가 보고했거나, 유저에게 할당된 모든 버그 목록을 열어 대쉬보드 뷰에서 검색하도록 하는 겁니다. <br />
where 구문 몇개와, 바인딩 패러미터를 사용해서 DQL 구문을 만들겁니다.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// dashboard.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$theUserId</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT b, e, r FROM Bug b JOIN b.engineer e JOIN b.reporter r &quot;</span><span class="o">.</span>
       <span class="s2">&quot;WHERE b.status = &#39;OPEN&#39; AND (e.id = ?1 OR r.id = ?1) ORDER BY b.created DESC&quot;</span><span class="p">;</span>

<span class="nv">$myBugs</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">)</span>
                        <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$theUserId</span><span class="p">)</span>
                        <span class="o">-&gt;</span><span class="na">setMaxResults</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
                        <span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>

<span class="k">echo</span> <span class="s2">&quot;You have created or assigned to &quot;</span> <span class="o">.</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$myBugs</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot; open bugs:</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$myBugs</span> <span class="k">as</span> <span class="nv">$bug</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()</span> <span class="o">.</span> <span class="s2">&quot; - &quot;</span> <span class="o">.</span> <span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getDescription</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="number-of-bugs">
<h2>버그 개수<a class="headerlink" href="#number-of-bugs" title="Permalink to this headline">¶</a></h2>
<p>지금까지는 엔티티를 검색하거나 그 배열 표현하기만 배웠습니다. <br />
독트린은 DQL을 사용해서 엔티티가 아닌 것도 검색할 수 있습니다. <br />
COUNT, SUM, MIN, MAX, AVG 함수 같은 "스칼라 결과 값"이라 불리는 합계값들입니다.</p>
<p>이걸 알아야 products 별로 오픈된 버그 수를 검색해 낼 수 있습니다.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// products.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT p.id, p.name, count(b.id) AS openBugs FROM Bug b &quot;</span><span class="o">.</span>
       <span class="s2">&quot;JOIN b.products p WHERE b.status = &#39;OPEN&#39; GROUP BY p.id&quot;</span><span class="p">;</span>
<span class="nv">$productBugs</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getScalarResult</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$productBugs</span> <span class="k">as</span> <span class="nv">$productBug</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$productBug</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot; has &quot;</span> <span class="o">.</span> <span class="nv">$productBug</span><span class="p">[</span><span class="s1">&#39;openBugs&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot; open bugs!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="updating-entities">
<h2>엔티티들 업데이트 하기<a class="headerlink" href="#updating-entities" title="Permalink to this headline">¶</a></h2>
<p>요구사항에서 빠진 것이 하나 있는데요, 엔지니어가 버그를 닫을 수 있어야 합니다. 이런식으로 말이죠.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// src/Bug.php</span>

<span class="k">class</span> <span class="nc">Bug</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">close</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">status</span> <span class="o">=</span> <span class="s2">&quot;CLOSE&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// close_bug.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$theBugId</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="nv">$bug</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s2">&quot;Bug&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$theBugId</span><span class="p">);</span>
<span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">close</span><span class="p">();</span>

<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>
</pre></div>
</div>
<p>데이터베이스에서 버그를 검색할 때, 이것은 독트린 UnitOfWork 내부의 IdentityMap에 입력되어 있습니다. <br />
즉, 전체 요청 중 얼마나 자주 <code class="docutils literal"><span class="pre">EntityManager#find()</span></code>를 호출하던 관계 없이 정확히 이 id를 가진 버그는 한 번만 존재한다는 의미입니다. <br />
심지어 DQL을 통해 변환시킨 엔티티, 이미 Identity Map에 존재하는 엔티티 모두 감지합니다. </p>
<p>flush가 호출될 때, 엔티티매니저는 identity map에 있는 모든 엔티티를 체크해서, 데이터베이스에서 검색된 원본과 현재 엔티티에 적힌 값을 비교시킵니다. <br />
이런 속성들 중 한개라도 다르면, 엔티티는 데이터베이스 UPDATE를 준비합니다. <br />
모든 속성을 업데이트 하는 것에 비해 아주 좋은 성능 향상을 제공하는 변경 컬럼만 update 됩니다.</p>
</div>
<div class="section" id="entity-repositories">
<h2>엔티티 저장소<a class="headerlink" href="#entity-repositories" title="Permalink to this headline">¶</a></h2>
<p>모델에서 어떻게 독트린 쿼리 로직을 분리하는지는 아직 다루지 않았습니다. <br />
독트린 1에서는 <code class="docutils literal"><span class="pre">Doctrine_Table</span></code> 인스턴스 개념으로 분리를 시켰습니다. <br />
독트린 2의 유사 개념은 엔티티 저장소 인데, 독트린의 심장에 <a class="reference external" href="http://martinfowler.com/eaaCatalog/repository.html">저장소 패턴</a>을 통합시킨 것입니다.</p>
<p>기본적으로 모든 엔티티는 기본 저장소를 사용하여, 엔티티 인스턴스를 조회하는데 사용할 수 있는, 편리한 여러 메소드들을 제공합니다. <br />
우리가 작성한 Product 엔티티가 그 예입니다. 만약 이름으로 조회하고 싶으면 이렇게 할 수 있습니다. </p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$product</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">)</span>
                         <span class="o">-&gt;</span><span class="na">findOneBy</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$productName</span><span class="p">));</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">findOneBy()</span></code> 메소드는 필드나 연결 키, 그리고 그 필드나 키에 해당되는 값을 배열로 받습니다.</p>
<p><code class="docutils literal"><span class="pre">findBy()</span></code> 메소드를 사용하면, 조건에 맞는 모든 엔티티를 사용할 수 있습니다. <br />
다음은 닫혀 있는 모든 버그를 조회하는 예제입니다.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$bugs</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;Bug&#39;</span><span class="p">)</span>
                      <span class="o">-&gt;</span><span class="na">findBy</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;status&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;CLOSED&#39;</span><span class="p">));</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$bugs</span> <span class="k">as</span> <span class="nv">$bug</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do stuff</span>
<span class="p">}</span>
</pre></div>
</div>
<p>DQL과 비교해 볼 때, 이 조회 메소드는 짧고, 빠릅니다. <br />
독트린은 기본 <code class="docutils literal"><span class="pre">EntityRepository</span></code>(엔티티 저장소)의 기능을 확장할 수 있는 편리한 방법을 제공하rh 모든 전문 DQL 쿼리 로직을 집어 넣었습니다. <br />
이걸 위해서는 <code class="docutils literal"><span class="pre">Doctrine\ORM\EntityRepository</span></code>의 서브 클래스를 만들어야 하는데, 우리의 경우에는 <code class="docutils literal"><span class="pre">BugRepository</span></code> 라는 이름을 붙여서 앞에서 검토한 쿼리 기능들을 묶어보겠습니다. </p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// src/BugRepository.php</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityRepository</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">BugRepository</span> <span class="k">extends</span> <span class="nx">EntityRepository</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getRecentBugs</span><span class="p">(</span><span class="nv">$number</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT b, e, r FROM Bug b JOIN b.engineer e JOIN b.reporter r ORDER BY b.created DESC&quot;</span><span class="p">;</span>

        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">);</span>
        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">setMaxResults</span><span class="p">(</span><span class="nv">$number</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getRecentBugsArray</span><span class="p">(</span><span class="nv">$number</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT b, e, r, p FROM Bug b JOIN b.engineer e &quot;</span><span class="o">.</span>
               <span class="s2">&quot;JOIN b.reporter r JOIN b.products p ORDER BY b.created DESC&quot;</span><span class="p">;</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">);</span>
        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">setMaxResults</span><span class="p">(</span><span class="nv">$number</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">getArrayResult</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getUsersBugs</span><span class="p">(</span><span class="nv">$userId</span><span class="p">,</span> <span class="nv">$number</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT b, e, r FROM Bug b JOIN b.engineer e JOIN b.reporter r &quot;</span><span class="o">.</span>
               <span class="s2">&quot;WHERE b.status = &#39;OPEN&#39; AND e.id = ?1 OR r.id = ?1 ORDER BY b.created DESC&quot;</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">)</span>
                             <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$userId</span><span class="p">)</span>
                             <span class="o">-&gt;</span><span class="na">setMaxResults</span><span class="p">(</span><span class="nv">$number</span><span class="p">)</span>
                             <span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getOpenBugsByProduct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT p.id, p.name, count(b.id) AS openBugs FROM Bug b &quot;</span><span class="o">.</span>
               <span class="s2">&quot;JOIN b.products p WHERE b.status = &#39;OPEN&#39; GROUP BY p.id&quot;</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getScalarResult</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>이 쿼리 로직이 <code class="docutils literal"><span class="pre">$this-&gt;getEntityManager()-&gt;getRepository('Bug')</span></code>를 사용할 수 있도록 메타데이터를 약간 수정합니다.</p>
<div class="configuration-block">
<ul class="simple">
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * @Entity(repositoryClass=&quot;BugRepository&quot;)</span>
<span class="sd"> * @Table(name=&quot;bugs&quot;)</span>
<span class="sd"> **/</span>
<span class="k">class</span> <span class="nc">Bug</span>
<span class="p">{</span>
    <span class="c1">//...</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;doctrine-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping&quot;</span>
      <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping</span>
<span class="s">                    http://raw.github.com/doctrine/doctrine2/master/doctrine-mapping.xsd&quot;</span><span class="nt">&gt;</span>

      <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">&quot;Bug&quot;</span> <span class="na">table=</span><span class="s">&quot;bugs&quot;</span> <span class="na">repository-class=</span><span class="s">&quot;BugRepository&quot;</span><span class="nt">&gt;</span>

      <span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;/doctrine-mapping&gt;</span>
</pre></div>
</div>
</li>
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">Bug</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">entity</span>
  <span class="l l-Scalar l-Scalar-Plain">repositoryClass</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">BugRepository</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>이제 모든 곳에서 쿼리 로직을 지우고, 대신 엔티티 저장소로 그것을 사용합니다. <br />
다음은 첫 사용 예제 "버그 목록" 의 샘플 코드입니다.
</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// list_bugs_repository.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$bugs</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;Bug&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getRecentBugs</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$bugs</span> <span class="k">as</span> <span class="nv">$bug</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getDescription</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot; - &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getCreated</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">format</span><span class="p">(</span><span class="s1">&#39;d.m.Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;    Reported by: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getReporter</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;    Assigned to: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getEngineer</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getProducts</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;    Platform: &quot;</span><span class="o">.</span><span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">echo</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>엔티티저장소를 사용하면, 특정 쿼리 로직과 모델이 합쳐지는 것을 막을 수 있습니다. <br />
또한 애플리케이션 전체에 걸쳐 쿼리 로직을 쉽게 재사용할 수 있습니다.</p>
<p><code class="docutils literal"><span class="pre">count()</span></code> 메소드는 필드나 연결 키와 그에 해당하는 값을 받습니다. <br />
이 메소드는, 별다른 옵션이 필요 없을 경우에, 쉽고 가볍게, 결과셋의 개수를 가져올 수 있습니다. 
</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$productCount</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
                         <span class="o">-&gt;</span><span class="na">count</span><span class="p">([</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$productName</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="section" id="conclusion">
<h2>결론<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>이번 튜토리얼은 여기까지 입니다. 재밌었기를 바랍니다. <br />
이 튜토리얼 이후로 계속 다음의 컨텐츠가 추가될 예정입니다. </p>
<ul class="simple">
<li>참조 매핑에 대한 더 많은 점</li>
<li>UnitOfWork의 라이프 사이클 이벤트 트리거</li>
<li>컬렉션 정렬</li>
</ul>
<p>여기서 설명된 모든 항목들의 별도 상세 설명은 각 메뉴얼 챕터에서 찾으실 수 있습니다.</p>
</div>
</div>


              </div>
                </div>

            </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
             
                <h3>Project Versions</h3>

                <select name="versions" id="versions">
            
            <option value="http://readthedocs.org/en/latest/">latest</option>
            
            <option value="http://readthedocs.org/en/stable/">stable</option>
            
                </select>
            
            <div id="searchbox" style="">
              <h3>Search</h3>
                <form class="search" action="http://readthedocs.org/search/project/" method="get">
                  <input type="text" name="q" size="18">
                  <input type="submit" value="Go">
                  <input type="hidden" name="selected_facets" value="project:Doctrine ORM">
                </form>
            </div>
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Getting Started with Doctrine</a><ul>
<li><a class="reference internal" href="#guide-assumptions">Guide Assumptions</a></li>
<li><a class="reference internal" href="#what-is-doctrine">What is Doctrine?</a><ul>
<li><a class="reference internal" href="#what-are-entities">What are Entities?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#an-example-model-bug-tracker">An Example Model: Bug Tracker</a></li>
<li><a class="reference internal" href="#project-setup">Project Setup</a></li>
<li><a class="reference internal" href="#obtaining-the-entitymanager">Obtaining the EntityManager</a></li>
<li><a class="reference internal" href="#generating-the-database-schema">Generating the Database Schema</a></li>
<li><a class="reference internal" href="#starting-with-the-product">Starting with the Product</a></li>
<li><a class="reference internal" href="#adding-bug-and-user-entities">Adding Bug and User Entities</a></li>
<li><a class="reference internal" href="#implementing-more-requirements">Implementing more Requirements</a></li>
<li><a class="reference internal" href="#queries-for-application-use-cases">Queries for Application Use-Cases</a><ul>
<li><a class="reference internal" href="#list-of-bugs">List of Bugs</a></li>
<li><a class="reference internal" href="#array-hydration-of-the-bug-list">Array Hydration of the Bug List</a></li>
<li><a class="reference internal" href="#find-by-primary-key">Find by Primary Key</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dashboard-of-the-user">Dashboard of the User</a></li>
<li><a class="reference internal" href="#number-of-bugs">Number of Bugs</a></li>
<li><a class="reference internal" href="#updating-entities">Updating Entities</a></li>
<li><a class="reference internal" href="#entity-repositories">Entity Repositories</a></li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="../index.html"
                                  title="previous chapter">Welcome to Doctrine 2 ORM&#8217;s documentation!</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="getting-started-database.html"
                                  title="next chapter">Getting Started: Database First</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/tutorials/getting-started.rst.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
        </div>
      </div>
          <div class="clearer"></div>
        </div>
          <div class="footer">
              &copy; Copyright 2010-%y, Doctrine Project Team.
              Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.5.3.
            <br/>
            <a target="_BLANK" href="http://www.servergrove.com"><img src="http://www.doctrine-project.org/images/servergrove.jpg" /></a>      <br/><br/>
            <form action="https://www.paypal.com/cgi-bin/webscr" method="post">
              <input type="hidden" name="cmd" value="_s-xclick" />
              <input type="hidden" name="hosted_button_id" value="BAE2E3XANQ77Y" />
              <input type="image" src="https://www.paypal.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!" />
              <img alt="" border="0" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1" />
            </form>
          </div>
      </div>

      <div id="bot-rcnr">
        <div class="tl"><!-- corner --></div>
      </div>
    </div>

  <script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
  </script>
  <script type="text/javascript">
  _uacct = "UA-288343-7";
  urchinTracker();
  </script>
  <a class="githublink" href="http://github.com/doctrine"><img src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"></a>
  </body>
</html>